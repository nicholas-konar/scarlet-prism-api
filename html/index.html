<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>AI Chat Test</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    sans-serif;
            }
            #app {
                display: grid;
                grid-template-columns: 280px 1fr;
                height: 100%;
            }
            .sidebar {
                border-right: 1px solid #eee;
                display: flex;
                flex-direction: column;
            }
            .sidebar header {
                padding: 12px;
                border-bottom: 1px solid #eee;
                display: flex;
                gap: 8px;
                align-items: center;
            }
            .sidebar header button {
                padding: 6px 10px;
            }
            .list {
                overflow: auto;
                padding: 8px;
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            .conv {
                padding: 8px;
                border: 1px solid #eee;
                border-radius: 8px;
                cursor: pointer;
                background: #fafafa;
            }
            .conv.active {
                border-color: #999;
                background: #f0f0f0;
            }
            .main {
                display: grid;
                grid-template-rows: auto 1fr auto;
                height: 100%;
            }
            .main header {
                padding: 12px 16px;
                border-bottom: 1px solid #eee;
                display: flex;
                gap: 12px;
                align-items: center;
            }
            .cid {
                font-size: 12px;
                color: #666;
                word-break: break-all;
            }
            #chat {
                overflow: auto;
                padding: 20px 16px;
                display: flex;
                flex-direction: column;
                gap: 14px;
            }
            .msg {
                white-space: pre-wrap;
                line-height: 1.45;
                padding: 10px 12px;
                border-radius: 10px;
                border: 1px solid #eee;
                background: #fff;
                max-width: 900px;
            }
            .msg.user {
                border-color: #cce5ff;
                background: #f5faff;
            }
            .msg.assistant {
                border-color: #eee;
                background: #fff;
            }
            .composer {
                display: flex;
                gap: 8px;
                padding: 12px;
                border-top: 1px solid #eee;
            }
            .composer input {
                flex: 1;
                padding: 10px 12px;
            }
            .composer button {
                padding: 10px 12px;
            }
            .empty {
                color: #777;
                font-size: 14px;
                padding: 20px;
            }
            .muted {
                color: #777;
                font-size: 12px;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <aside class="sidebar">
                <header>
                    <button id="new-conv">New conversation</button>
                </header>
                <div
                    id="conv-list"
                    class="list"
                    aria-label="Conversations"
                ></div>
            </aside>

            <main class="main">
                <header>
                    <div>
                        <div><strong>Chat</strong></div>
                        <div class="cid" id="cid">—</div>
                    </div>
                </header>

                <div id="chat"></div>

                <div class="composer">
                    <input
                        id="prompt"
                        type="text"
                        placeholder="Type your message…"
                        autocomplete="off"
                    />
                    <button id="send">Send</button>
                </div>
            </main>
        </div>

        <script>
            ;(() => {
                const API_URL = "http://localhost:3000"

                // --- Minimal store (localStorage) -----------------------------------------
                const LS_KEY = "chat-testing-state-v1"
                function loadState() {
                    try {
                        return (
                            JSON.parse(localStorage.getItem(LS_KEY)) || {
                                conversations: {},
                                order: [],
                            }
                        )
                    } catch {
                        return { conversations: {}, order: [] }
                    }
                }
                function saveState() {
                    localStorage.setItem(LS_KEY, JSON.stringify(state))
                }
                let state = loadState()
                let currentId = null
                let currentStream = null // EventSource or reader abort handle

                // conversation = { id, title, messages: [{role:'user'|'assistant', text}] }
                function ensureConversation(id) {
                    if (!state.conversations[id]) {
                        state.conversations[id] = {
                            id,
                            title: "New chat",
                            messages: [],
                        }
                        if (!state.order.includes(id)) state.order.unshift(id)
                        saveState()
                    }
                    return state.conversations[id]
                }

                // --- DOM elements ---------------------------------------------------------
                const convListEl = document.getElementById("conv-list")
                const chatEl = document.getElementById("chat")
                const cidEl = document.getElementById("cid")
                const promptEl = document.getElementById("prompt")
                const sendBtn = document.getElementById("send")
                const newConvBtn = document.getElementById("new-conv")

                // --- UI helpers -----------------------------------------------------------
                function renderSidebar() {
                    convListEl.innerHTML = ""
                    if (state.order.length === 0) {
                        const empty = document.createElement("div")
                        empty.className = "empty"
                        empty.textContent = "No conversations yet."
                        convListEl.appendChild(empty)
                        return
                    }
                    state.order.forEach((id) => {
                        const conv = state.conversations[id]
                        const el = document.createElement("div")
                        el.className =
                            "conv" + (id === currentId ? " active" : "")
                        el.title = id
                        el.innerHTML = `
        <div><strong>${escapeHtml(conv.title || "Chat")}</strong></div>
        <div class="muted" style="margin-top:4px">${id}</div>
      `
                        el.addEventListener("click", () => navigateTo(id))
                        convListEl.appendChild(el)
                    })
                }

                function renderChat() {
                    chatEl.innerHTML = ""
                    if (!currentId) {
                        const empty = document.createElement("div")
                        empty.className = "empty"
                        empty.textContent = "Click “New conversation” to begin."
                        chatEl.appendChild(empty)
                        cidEl.textContent = "—"
                        return
                    }
                    const conv = state.conversations[currentId]
                    cidEl.textContent = currentId

                    if (!conv || conv.messages.length === 0) {
                        const empty = document.createElement("div")
                        empty.className = "empty"
                        empty.textContent =
                            "This conversation is empty. Say something!"
                        chatEl.appendChild(empty)
                        return
                    }

                    conv.messages.forEach((m) => {
                        const div = document.createElement("div")
                        div.className = "msg " + m.role
                        div.textContent = m.text
                        chatEl.appendChild(div)
                    })

                    chatEl.scrollTop = chatEl.scrollHeight
                }

                function appendMessage(role, text) {
                    const conv = ensureConversation(currentId)
                    conv.messages.push({ role, text })
                    // Use first user line as title
                    if (!conv.title && role === "user")
                        conv.title = text.slice(0, 40)
                    saveState()

                    const div = document.createElement("div")
                    div.className = "msg " + role
                    div.textContent = text
                    chatEl.appendChild(div)
                    chatEl.scrollTop = chatEl.scrollHeight
                    renderSidebar()
                }

                function appendAssistantStreamingNode() {
                    const div = document.createElement("div")
                    div.className = "msg assistant"
                    div.textContent = ""
                    chatEl.appendChild(div)
                    chatEl.scrollTop = chatEl.scrollHeight
                    return div
                }

                function updateAssistantStreamingNode(node, chunk) {
                    node.textContent += chunk
                    chatEl.scrollTop = chatEl.scrollHeight
                }

                // --- Routing (#/c/<id>) ---------------------------------------------------
                function parseHash() {
                    const m = location.hash.match(/^#\/c\/(.+)$/)
                    return m ? m[1] : null
                }
                function navigateTo(id) {
                    if (currentId === id) return
                    location.hash = `#/c/${encodeURIComponent(id)}`
                }
                window.addEventListener("hashchange", () => {
                    const id = parseHash()
                    setCurrentConversation(id)
                })

                function setCurrentConversation(id) {
                    stopStream()
                    currentId = id
                    if (currentId) ensureConversation(currentId)
                    renderSidebar()
                    renderChat()
                }
                // --- Streaming logic ------------------------------------------------------
                function stopStream() {
                    if (currentStream && currentStream.close) {
                        currentStream.close() // EventSource
                    }
                    if (currentStream && currentStream.abort) {
                        currentStream.abort() // fetch reader controller
                    }
                    currentStream = null
                }

                async function startSSE(conversationId, prompt) {
                    // Abort handle compatible with your stopStream()
                    const ctrl = new AbortController()
                    currentStream = { abort: () => ctrl.abort() }

                    const res = await fetch(
                        `${API_URL}/c/${encodeURIComponent(conversationId)}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ prompt }),
                            signal: ctrl.signal,
                        },
                    )
                    if (!res.ok || !res.body)
                        throw new Error(`HTTP ${res.status}`)

                    const assistNode = appendAssistantStreamingNode()
                    const reader = res.body.getReader()
                    const decoder = new TextDecoder()

                    let buffer = ""
                    while (true) {
                        const { value, done } = await reader.read()
                        if (done) break
                        buffer += decoder.decode(value, { stream: true })

                        // Parse SSE frames: "<field>: <value>\n\n"
                        let sep
                        while ((sep = buffer.indexOf("\n\n")) !== -1) {
                            const frame = buffer.slice(0, sep)
                            buffer = buffer.slice(sep + 2)

                            if (frame.startsWith("event: done")) {
                                // finalize assistant message
                                currentStream = null
                                const conv = ensureConversation(conversationId)
                                conv.messages.push({
                                    role: "assistant",
                                    text: assistNode.textContent,
                                })
                                saveState()
                                break
                            }

                            if (frame.startsWith("data: ")) {
                                const data = frame.slice(6) // remove "data: "
                                updateAssistantStreamingNode(assistNode, data)
                            }

                            if (frame.startsWith("event: error")) {
                                console.error("SSE error frame:", frame)
                            }
                        }
                    }
                }

                // --- Actions --------------------------------------------------------------
                newConvBtn.addEventListener("click", async () => {
                    try {
                        const res = await fetch(`${API_URL}/c`, {
                            method: "POST",
                        })
                        const { conversationId } = await res.json()
                        ensureConversation(conversationId)
                        navigateTo(conversationId)
                    } catch (err) {
                        console.error(err)
                        alert("Failed to create conversation")
                    }
                })

                sendBtn.addEventListener("click", () => sendPrompt())
                promptEl.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault()
                        sendPrompt()
                    }
                })

                function sendPrompt() {
                    const prompt = promptEl.value.trim()
                    if (!currentId) {
                        return alert('Click "New conversation" first')
                    }
                    if (!prompt) return
                    promptEl.value = ""

                    appendMessage("user", prompt)
                    // Start streaming assistant
                    startSSE(currentId, prompt).catch((err) => {
                        console.error(err)
                        const errNode = document.createElement("div")
                        errNode.className = "msg assistant"
                        errNode.textContent = "[Failed to stream response]"
                        chatEl.appendChild(errNode)
                    })
                    // If using POST streaming, call startStreamingViaFetch(currentId, prompt) instead.
                }

                // --- Boot ---------------------------------------------------------------
                // restore current from URL or pick first
                const initial = parseHash()
                if (initial) {
                    setCurrentConversation(initial)
                } else if (state.order.length > 0) {
                    setCurrentConversation(state.order[0])
                    navigateTo(state.order[0])
                } else {
                    renderSidebar()
                    renderChat()
                }

                // --- Tiny HTML escaper ---------------------------------------------------
                function escapeHtml(s) {
                    return s.replace(
                        /[&<>"]/g,
                        (c) =>
                            ({
                                "&": "&amp;",
                                "<": "&lt;",
                                ">": "&gt;",
                                '"': "&quot;",
                            })[c],
                    )
                }
            })()
        </script>
    </body>
</html>
